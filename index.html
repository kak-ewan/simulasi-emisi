<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoEmisi AR ‚Äî Kids Edition</title>

<!-- Simple styles (no Tailwind) -->
<style>
  :root{
    --bg:#e6f7ff;
    --card:#ffffff;
    --accent:#2b8cff;
    --accent-2:#7bd389;
    --muted:#5b6b7a;
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#023047;}
  .wrap{max-width:460px; margin:12px auto; padding:12px;}
  h1{margin:0 0 6px 0; font-size:20px;}
  p.lead{margin:0 0 12px 0; color:var(--muted); font-size:13px;}
  .card{background:var(--card); border-radius:12px; padding:10px; box-shadow:0 6px 18px rgba(2,16,40,0.06); margin-bottom:10px;}
  .row{display:flex; gap:8px; align-items:center;}
  .big-btn{flex:1; background:var(--accent); color:white; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 6px 14px rgba(43,140,255,0.18);}
  .ghost-btn{background:transparent; border:2px solid var(--accent); color:var(--accent); padding:10px; border-radius:10px; font-weight:700; cursor:pointer;}
  .small{font-size:13px; color:var(--muted);}
  #object-list{max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:8px;}
  .obj{display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background:linear-gradient(180deg, #fff, #f7fdff);}
  .obj .title{font-weight:700;}
  .controls{display:flex; gap:8px; margin-top:8px; align-items:center;}
  select{padding:8px; border-radius:8px; border:1px solid #dbeffd;}
  #map{height:150px; border-radius:10px; overflow:hidden; margin-top:8px;}
  /* Camera preview */
  #preview{height:320px; border-radius:12px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative;}
  #camera { width:100%; height:100%; object-fit:cover; }
  .overlay-top{position:absolute; top:8px; left:8px; right:8px; display:flex; justify-content:space-between; pointer-events:none;}
  .chip{background:rgba(255,255,255,0.9); padding:6px 8px; border-radius:999px; font-weight:700; pointer-events:auto;}
  .floating-sampai{position:absolute; bottom:12px; left:50%; transform:translateX(-50%); pointer-events:auto;}
  .emission{display:flex; gap:8px; align-items:center;}
  .cloud{width:56px; height:56px; display:flex; align-items:center; justify-content:center; border-radius:999px; background:linear-gradient(180deg,#fff,#f0f8ff); box-shadow:0 6px 18px rgba(2,16,40,0.06);}
  .result-big{font-size:18px; font-weight:800; color:#023047;}
  .muted{color:var(--muted); font-size:13px;}
  /* Fullscreen AR modal */
  #ar-modal{position:fixed; inset:0; background:#000; display:none; z-index:9999; align-items:center; justify-content:center;}
  #ar-topbar{position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; pointer-events:none;}
  .ar-btn{pointer-events:auto; background:rgba(255,255,255,0.9); padding:8px 10px; border-radius:10px; font-weight:800; border:none; cursor:pointer;}
  .ar-sampai{background:var(--accent-2); color:white;}
  @media (max-width:420px){ .wrap{padding:8px;} h1{font-size:18px;} }
</style>

<!-- model-viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

</head>
<body>
  <div class="wrap">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
      <div class="cloud" aria-hidden="true">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 17H6a4 4 0 010-8 5 5 0 019.9-1.2A3.5 3.5 0 0119 11.5 3.5 3.5 0 0119 17z" fill="#7dd3fc"/></svg>
      </div>
      <div>
        <h1>GeoEmisi AR (Kids)</h1>
        <p class="lead">Pilih objek, lihat di dunia nyata, ketuk <strong>Sampai</strong> untuk lihat emisi.</p>
      </div>
    </div>

    <div class="card" id="preview">
      <video id="camera" autoplay playsinline muted></video>

      <div class="overlay-top">
        <div class="chip" id="chip-selected">Belum pilih</div>
        <div style="display:flex; gap:8px;">
          <button class="ghost-btn" id="btn-center" style="pointer-events:auto;">Saya</button>
          <button class="ghost-btn" id="btn-refresh" style="pointer-events:auto;">Muat Ulang</button>
        </div>
      </div>

      <div class="floating-sampai">
        <button id="btn-sampai" class="big-btn">Sampai ‚úÖ</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div><strong>Pilih Kendaraan</strong><div class="muted">Pilih satu dulu</div></div>
        <div>
          <select id="vehicle">
            <option value="motor">üõµ Motor</option>
            <option value="mobil" selected>üöó Mobil</option>
            <option value="truk">üöö Truk</option>
            <option value="cidomo">üêé Cidomo</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="small" style="margin-bottom:6px;"><strong>Daftar Objek</strong></div>
        <div id="object-list" aria-live="polite"></div>
      </div>

      <div id="map" style="margin-top:10px;"></div>
    </div>

    <div class="card row" style="justify-content:space-between; align-items:center;">
      <div class="emission">
        <div class="cloud" aria-hidden="true">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10" stroke="#60a5fa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="17" cy="17" r="3" fill="#a7f3d0"/></svg>
        </div>
        <div style="margin-left:8px;">
          <div class="muted">Hasil Emisi</div>
          <div id="result-text" class="result-big">Belum ada</div>
        </div>
      </div>

      <div style="text-align:right;">
        <div class="muted">Jarak</div>
        <div id="result-distance" style="font-weight:800; font-size:18px;">-</div>
      </div>
    </div>

  </div>

  <div id="ar-modal" role="dialog" aria-hidden="true">
    <div id="ar-topbar">
      <button id="ar-exit" class="ar-btn">Keluar ‚úñ</button>
      <div style="display:flex; gap:8px;">
        <button id="ar-sampai-btn" class="ar-btn ar-sampai">Sampai ‚úÖ</button>
      </div>
    </div>

    <model-viewer id="mv"
      camera-controls
      ar
      ar-modes="webxr scene-viewer quick-look"
      interaction-prompt="auto"
      style="width:100vw; height:100vh; background:transparent;">
    </model-viewer>
  </div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';
const FACTORS = { motor:120, mobil:200, truk:900, cidomo:0 };

let items = [];
let selected = null;
let startPoint = null;
let endPoint = null;

const objectList = document.getElementById('object-list');
const chipSelected = document.getElementById('chip-selected');
const mv = document.getElementById('mv');
const arModal = document.getElementById('ar-modal');
const arExit = document.getElementById('ar-exit');
const arSampaiBtn = document.getElementById('ar-sampai-btn');
const btnSampai = document.getElementById('btn-sampai');
const vehicle = document.getElementById('vehicle');
const resultText = document.getElementById('result-text');
const resultDistance = document.getElementById('result-distance');
const btnRefresh = document.getElementById('btn-refresh');
const btnCenter = document.getElementById('btn-center');
const cameraEl = document.getElementById('camera');

let map = null;
let markers = {};

function initMap(){
  map = L.map('map',{zoomControl:false}).setView([0,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);
}

function parseCSV(text){
  const lines = text.trim().split('\n').filter(Boolean);
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.findIndex(h=>h==='name' || h==='nama' || h.includes('name'));
  const urlIdx  = headers.findIndex(h=>h==='url' || h.includes('url'));
  if(nameIdx===-1 || urlIdx===-1) throw new Error('CSV harus punya kolom name/nama dan url');
  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(',').map(c=>c.trim());
    const nama=cols[nameIdx]; const url=cols[urlIdx];
    if(nama && url) out.push({id:'i'+i,title:nama,url, startRecorded:false});
  }
  return out;
}

async function loadCSV(){
  try{
    const r=await fetch(CSV_URL);
    const txt=await r.text();
    items=parseCSV(txt);
    renderList();
  }catch(e){
    console.error('CSV error',e);
    objectList.innerHTML='<div style="color:red">Gagal memuat CSV üò¢</div>';
  }
}

function renderList(){
  objectList.innerHTML='';
  if(items.length===0){
    objectList.innerHTML='<div class="muted small">Tidak ada objek</div>';
    return;
  }
  items.forEach(it=>{
    const el=document.createElement('div');
    el.className='obj';
    el.style.background='#e0f2fe';
    el.innerHTML=`
      <div style="min-width:0">
        <div class="title">${it.title}</div>
        <div class="muted small">${it.startRecorded?'Start tercatat':'Klik Pilih untuk mulai'}</div>
      </div>
      <div style="display:flex; gap:6px;">
        <button data-id="${it.id}" class="ghost-btn select-btn">Pilih</button>
        <button data-id="${it.id}" class="big-btn view-btn">Lihat</button>
      </div>`;
    objectList.appendChild(el);
  });

  document.querySelectorAll('.select-btn').forEach(b=>{
    b.addEventListener('click',e=>handleSelect(e.currentTarget.dataset.id));
  });
  document.querySelectorAll('.view-btn').forEach(b=>{
    b.addEventListener('click',e=>handleView(e.currentTarget.dataset.id));
  });
}

function getGeo(opts={}) {
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej('no geo');
    navigator.geolocation.getCurrentPosition(res,rej,opts);
  });
}

async function handleSelect(id){
  const it=items.find(x=>x.id===id);
  if(!it) return;
  try{
    const pos=await getGeo({enableHighAccuracy:true,timeout:10000});
    it.lat=pos.coords.latitude; it.lng=pos.coords.longitude;
    it.startRecorded=true;
    selected=it; startPoint={lat:it.lat,lng:it.lng};
    chipSelected.textContent=`${it.title} ‚Ä¢ Start dicatat`;
    placeStart(it);
    renderList();
    if(map) map.setView([it.lat,it.lng],16);
  }catch(e){alert('Tidak bisa ambil lokasi');}
}

function handleView(id){
  const it=items.find(x=>x.id===id);
  if(!it) return;
  selected=it;
  mv.src=it.url;
  openAR();
}

function openAR(){
  arModal.style.display='flex';
  try{document.documentElement.requestFullscreen?.();}catch(e){}
}
function closeAR(){
  arModal.style.display='none';
  try{if(document.fullscreenElement)document.exitFullscreen?.();}catch(e){}
}

async function handleSampai(){
  if(!selected||!selected.startRecorded){alert('Pilih objek dulu.');return;}
  try{
    const pos=await getGeo({enableHighAccuracy:true,timeout:10000});
    endPoint={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const m=dist(selected.lat,selected.lng,endPoint.lat,endPoint.lng);
    const km=m/1000;
    const veh=vehicle.value;
    const kg=(km*(FACTORS[veh]||FACTORS.mobil))/1000;
    resultText.textContent=`${kg.toFixed(3)} kg CO‚ÇÇ`;
    resultDistance.textContent=`${km.toFixed(3)} km`;
    placeEnd(endPoint);
    drawRoute(selected,endPoint);
    closeAR();
  }catch(e){alert('Gagal ambil lokasi');}
}

function dist(a,b,c,d){
  const R=6371e3,rad=x=>x*Math.PI/180;
  const œÜ1=rad(a),œÜ2=rad(c),dœÜ=rad(c-a),dŒª=rad(d-b);
  const x=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function placeStart(it){
  if(!map)return;
  if(markers[it.id])map.removeLayer(markers[it.id]);
  markers[it.id]=L.marker([it.lat,it.lng]).addTo(map).bindPopup(it.title+' (Start)');
}
function placeEnd(pt){
  if(!map)return;
  if(markers.end)map.removeLayer(markers.end);
  markers.end=L.marker([pt.lat,pt.lng]).addTo(map).bindPopup('Sampai');
}
function drawRoute(a,b){
  if(!map)return;
  if(markers.route)map.removeLayer(markers.route);
  const pl=L.polyline([[a.lat,a.lng],[b.lat,b.lng]],{color:'#2b8cff'}).addTo(map);
  markers.route=pl;
  map.fitBounds(pl.getBounds(),{padding:[20,20]});
}

async function startCam(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    cameraEl.srcObject=s;
  }catch(e){console.warn(e);}
}

arExit.addEventListener('click',closeAR);
arSampaiBtn.addEventListener('click',handleSampai);
btnSampai.addEventListener('click',handleSampai);
btnRefresh.addEventListener('click',loadCSV);
btnCenter.addEventListener('click',async()=>{
  try{
    const p=await getGeo({enableHighAccuracy:true,timeout:8000});
    map.setView([p.coords.latitude,p.coords.longitude],16);
  }catch(e){}
});

(async()=>{
  initMap();
  await loadCSV();
  await startCam();
  try{
    const p=await getGeo({enableHighAccuracy:true,timeout:8000});
    map.setView([p.coords.latitude,p.coords.longitude],15);
  }catch(e){}
})();
</script>

</body>
</html>
