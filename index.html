<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoEmisi AR ‚Äî Simulasi Jejak Karbon (Auto Kamera)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; background: #000; }
    .overlay-ui { position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 10px 14px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); z-index: 20; width: calc(100% - 36px); max-width: 460px; }
    .overlay-ui select, .overlay-ui button { font-size: 14px; }
    .hud-info { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 8px 14px; border-radius: 8px; z-index: 20; text-align: center; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; vertical-align:middle; }
    .camera-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
    .camera-feed { width: 100%; height: 100%; object-fit: cover; }
    .ar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }
    .ar-object { position: absolute; transform: translate(-50%, -50%); pointer-events: auto; }
    .model-container { 
      width: 100px; 
      height: 100px; 
      background: rgba(59, 130, 246, 0.8); 
      border-radius: 10px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 100;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p id="loading-status">Menyiapkan kamera dan GPS...</p>
  </div>

  <!-- Camera View -->
  <div class="camera-container">
    <video id="camera-feed" class="camera-feed" autoplay playsinline></video>
    <div class="ar-overlay" id="ar-overlay"></div>
  </div>

  <!-- HUD GPS Status -->
  <div class="hud-info" id="gpsHud">
    <span id="gpsDot" class="status-dot" style="background:#f59e0b"></span>
    <span id="gpsText">üì° Mendeteksi lokasi...</span>
  </div>

  <!-- Panel Kontrol -->
  <div class="overlay-ui" role="region" aria-label="Kontrol GeoEmisi">
    <div class="flex flex-col gap-2">
      <div>
        <label class="text-xs text-gray-600">Pilih Objek (CSV: nama, url)</label>
        <select id="objectSelect" class="w-full border rounded px-2 py-1" aria-label="Pilih objek"></select>
      </div>
      <div class="flex gap-2">
        <button id="btnPlace" class="flex-1 bg-blue-600 text-white rounded px-3 py-2">Letakkan Objek</button>
        <button id="btnStart" class="flex-1 bg-emerald-500 text-white rounded px-3 py-2">Start</button>
        <button id="btnFinish" class="flex-1 bg-red-500 text-white rounded px-3 py-2" disabled>Finish</button>
      </div>
      <div>
        <label class="text-xs text-gray-600">Mode Transportasi</label>
        <select id="transportMode" class="w-full border rounded px-2 py-1" aria-label="Mode transportasi">
          <option value="motor">Motor Pribadi</option>
          <option value="mobil">Mobil Pribadi</option>
          <option value="umum">Angkutan Umum</option>
          <option value="truk">Truk</option>
        </select>
      </div>
      <div class="text-sm text-gray-800 mt-2">
        <div>Jarak tempuh: <strong id="distVal">0.00</strong> km</div>
        <div>Emisi CO‚ÇÇ: <strong id="emisVal">0.00</strong> kg</div>
      </div>
    </div>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';
    const emissionFactors = { motor: 0.1, mobil: 0.25, umum: 0.05, truk: 0.4 };

    let objects = [];
    let currentPosition = null;
    let watchId = null;
    let simActive = false;
    let simStartPos = null;
    let simDist = 0;
    let cameraStream = null;
    let currentModel = null;

    // Parse CSV data
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.toLowerCase());
      const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('nama'));
      const urlIdx = headers.findIndex(h => h.includes('url'));
      return lines.slice(1).map(l => {
        const cols = l.split(',');
        return { name: cols[nameIdx]?.trim(), url: cols[urlIdx]?.trim() };
      });
    }

    // Load CSV data
    async function loadCSV() {
      try {
        updateLoadingStatus('Memuat data objek...');
        const res = await fetch(csvUrl);
        const text = await res.text();
        objects = parseCSV(text);
        const sel = document.getElementById('objectSelect');
        sel.innerHTML = '<option value="">-- pilih objek --</option>';
        objects.forEach((o,i)=>{
          const opt = document.createElement('option'); 
          opt.value=i; 
          opt.textContent=o.name; 
          sel.appendChild(opt);
        });
      } catch (e) {
        alert('Gagal memuat CSV');
        console.error(e);
      }
    }

    // Start camera
    async function startCamera() {
      try {
        updateLoadingStatus('Mengakses kamera...');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Browser tidak mendukung akses kamera');
        }

        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });

        const videoElement = document.getElementById('camera-feed');
        videoElement.srcObject = cameraStream;
        
        // Hide loading screen when video starts playing
        videoElement.onloadeddata = () => {
          setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
          }, 1000);
        };

      } catch (error) {
        console.error('Error accessing camera:', error);
        let errorMessage = 'Tidak dapat mengakses kamera: ';
        
        if (error.name === 'NotAllowedError') {
          errorMessage += 'Izin kamera ditolak. Silakan izinkan akses kamera dan muat ulang halaman.';
        } else if (error.name === 'NotFoundError') {
          errorMessage += 'Tidak ada kamera yang ditemukan.';
        } else if (error.name === 'NotSupportedError') {
          errorMessage += 'Browser tidak mendukung akses kamera.';
        } else {
          errorMessage += error.message;
        }
        
        updateLoadingStatus(errorMessage);
        alert(errorMessage);
      }
    }

    // Place 3D model in AR
    function placeModel(url) {
      const overlay = document.getElementById('ar-overlay');
      
      // Remove existing model
      if (currentModel) {
        overlay.removeChild(currentModel);
      }
      
      // Create new model container
      currentModel = document.createElement('div');
      currentModel.className = 'ar-object';
      currentModel.style.left = '50%';
      currentModel.style.top = '50%';
      
      // Create model content based on file type
      if (url.toLowerCase().includes('.glb') || url.toLowerCase().includes('.gltf')) {
        // For 3D models, show a placeholder
        const modelContainer = document.createElement('div');
        modelContainer.className = 'model-container';
        modelContainer.textContent = '3D Model';
        modelContainer.style.background = 'rgba(139, 69, 19, 0.8)';
        currentModel.appendChild(modelContainer);
      } else if (url.match(/\.(jpeg|jpg|gif|png)$/i)) {
        // For images
        const img = document.createElement('img');
        img.src = url;
        img.style.width = '150px';
        img.style.height = '150px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '10px';
        img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
        img.onerror = function() {
          this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 24 24" fill="none" stroke="%234f46e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
        };
        currentModel.appendChild(img);
      } else {
        // For other content types
        const contentContainer = document.createElement('div');
        contentContainer.className = 'model-container';
        contentContainer.textContent = 'Object';
        currentModel.appendChild(contentContainer);
      }
      
      overlay.appendChild(currentModel);
    }

    // Start location tracking
    function startWatch() {
      if(!navigator.geolocation) {
        updateGPSStatus(false, '‚ùå GPS tidak didukung');
        return;
      }
      
      updateGPSStatus(false, 'üì° Mendeteksi lokasi...');
      watchId = navigator.geolocation.watchPosition(
        position => {
          currentPosition = {
            lat: position.coords.latitude, 
            lng: position.coords.longitude
          };
          updateGPSStatus(true, '‚úÖ GPS aktif');
          
          if(simActive && simStartPos){
            const d = haversine(simStartPos, currentPosition);
            simDist = d / 1000; // Convert meters to kilometers
            document.getElementById('distVal').textContent = simDist.toFixed(2);
            const mode = document.getElementById('transportMode').value;
            const emisi = simDist * (emissionFactors[mode] || 0);
            document.getElementById('emisVal').textContent = emisi.toFixed(2);
          }
        }, 
        error => {
          console.error('GPS Error:', error);
          let errorMsg = 'Gagal mendapatkan lokasi';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = 'Izin lokasi ditolak';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = 'Informasi lokasi tidak tersedia';
              break;
            case error.TIMEOUT:
              errorMsg = 'Permintaan lokasi timeout';
              break;
          }
          updateGPSStatus(false, errorMsg);
        }, 
        {
          enableHighAccuracy: true,
          maximumAge: 10000,
          timeout: 15000
        }
      );
    }

    // Update GPS status display
    function updateGPSStatus(ok, text){
      const dot = document.getElementById('gpsDot');
      const t = document.getElementById('gpsText');
      dot.style.background = ok ? '#16a34a' : '#f59e0b';
      t.textContent = text;
    }

    // Update loading status
    function updateLoadingStatus(text) {
      document.getElementById('loading-status').textContent = text;
    }

    // Haversine distance calculation
    function haversine(a, b){
      const R = 6371000; // Earth radius in meters
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
      return R * c; // Return distance in meters
    }

    // Event listeners
    document.getElementById('btnPlace').addEventListener('click', () => {
      const idx = document.getElementById('objectSelect').value;
      if(idx === '') return alert('Pilih objek terlebih dahulu.');
      const obj = objects[idx];
      placeModel(obj.url);
    });

    document.getElementById('btnStart').addEventListener('click', () => {
      if(!currentPosition) return alert('Menunggu GPS...');
      simStartPos = {...currentPosition};
      simDist = 0;
      simActive = true;
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnFinish').disabled = false;
      updateGPSStatus(true, 'üü¢ Simulasi dimulai ‚Äî merekam posisi...');
    });

    document.getElementById('btnFinish').addEventListener('click', () => {
      if(!simActive) return alert('Simulasi belum dimulai');
      simActive = false;
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnFinish').disabled = true;
      const mode = document.getElementById('transportMode').value;
      const emisi = simDist * (emissionFactors[mode] || 0);
      document.getElementById('emisVal').textContent = emisi.toFixed(2);
      updateGPSStatus(true, '‚úÖ Simulasi selesai');
      alert(`Simulasi selesai!\nJarak: ${simDist.toFixed(2)} km\nEmisi CO‚ÇÇ: ${emisi.toFixed(2)} kg`);
    });

    // Initialize app
    async function initApp() {
      try {
        await startCamera();
        await loadCSV();
        startWatch();
      } catch (error) {
        console.error('Initialization error:', error);
        updateLoadingStatus('Error inisialisasi: ' + error.message);
      }
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initApp);

    // Clean up when page closes
    window.addEventListener('beforeunload', () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
  </script>
</body>
</html>
