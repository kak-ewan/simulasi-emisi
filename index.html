<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoEmisi AR — Fullscreen AR</title>

<!-- TailwindCSS (CDN) for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- model-viewer for .glb & AR -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

<style>
  :root{
    --bg:#071027;
    --panel: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.6);
    --accent: #7c3aed;
  }
  html,body{height:100%; background:linear-gradient(180deg,#031226 0%, #071027 60%); color:#E6EEF8; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  .app-shell{max-width:1200px;margin:24px auto;padding:18px;}
  .glass{background:var(--panel); backdrop-filter:blur(6px); border-radius:14px; box-shadow:0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03);}
  .floating-card{padding:12px;}
  .btn {transition:all .18s cubic-bezier(.2,.9,.2,1); border-radius:10px; padding:8px 12px; font-weight:600;}
  .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#4f46e5); color:white; box-shadow:0 8px 30px rgba(79,70,229,0.12);}
  #camera-feed{width:100%; height:100%; object-fit:cover; display:block;}
  /* AR fullscreen modal */
  #ar-fullscreen{ position:fixed; inset:0; z-index:70; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25)); }
  #ar-inner{ width:100%; height:100%; display:flex; flex-direction:column; }
  .ar-top { display:flex; justify-content:space-between; gap:12px; padding:12px; align-items:center; }
  .ar-controls { display:flex; gap:8px; align-items:center; }
  model-viewer { width:100%; height:calc(100vh - 72px); background:transparent; }
  .hide-when-ar{ transition:opacity .25s ease; }
  .show { display:flex; }
  .fade-in { animation:fadeIn .22s ease both; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:none;} }
  /* object list */
  #object-list { max-height:56vh; overflow:auto; padding-right:6px; }
  .obj-row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(255,255,255,0.02); }
  .muted { color:var(--muted); font-size:13px; }
  /* small map */
  #student-map { height:260px; border-radius:10px; overflow:hidden; }
  /* emission card */
  .emission-card { padding:12px; border-radius:10px; background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(79,70,229,0.06)); color:white; }
  /* responsive */
  @media (max-width:900px){
    .app-shell{margin:8px;}
  }
</style>
</head>
<body>
  <div class="app-shell">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">GeoEmisi AR</h1>
        <div class="muted">Pilih objek → rekam lokasi start → lihat AR fullscreen → tekan "Sampai" untuk menghitung emisi.</div>
      </div>
      <div class="flex items-center gap-3">
        <select id="vehicle-select" class="btn btn-ghost">
          <option value="motor">Motor</option>
          <option value="mobil" selected>Mobil</option>
          <option value="truk">Truk</option>
        </select>
        <button id="btn-sampai-floating" class="btn btn-primary">Sampai</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Left: Camera preview + AR quick area -->
      <div class="lg:col-span-2 glass floating-card relative">
        <div class="flex items-center justify-between mb-3">
          <div class="muted">Preview Kamera</div>
          <div class="muted text-sm">AR mode akan fullscreen saat lihat objek</div>
        </div>

        <div id="camera-area" class="rounded-lg overflow-hidden" style="height:420px; position:relative;">
          <video id="camera-feed" autoplay playsinline muted></video>

          <!-- overlay UI on top of camera preview -->
          <div style="position:absolute; inset:12px; pointer-events:none;">
            <div style="display:flex; justify-content:flex-start; gap:8px;">
              <div id="selected-chip" class="muted glass px-3 py-1 rounded-md hide-when-ar">Belum memilih objek</div>
            </div>
            <div style="position:absolute; right:12px; bottom:12px; pointer-events:auto;">
              <button id="open-map-btn" class="btn btn-ghost hide-when-ar">Buka Peta</button>
            </div>
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="muted">Status: <span id="status">Memuat objek...</span></div>
          <div class="flex gap-2">
            <button id="refresh-csv" class="btn btn-ghost">Muat ulang CSV</button>
            <button id="center-me" class="btn btn-ghost">Cari Saya</button>
          </div>
        </div>
      </div>

      <!-- Right: List + Map + Emission -->
      <div class="glass floating-card">
        <div class="mb-3">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Daftar Objek</h3>
            <div class="muted text-sm">CSV publik</div>
          </div>
        </div>

        <div id="object-list" class="space-y-2 mb-3">
          <!-- rows injected -->
        </div>

        <div class="mb-3">
          <h4 class="font-semibold mb-2">Peta</h4>
          <div id="student-map"></div>
        </div>

        <div class="emission-card">
          <div class="flex items-center justify-between">
            <div>
              <div class="muted">Hasil Terakhir</div>
              <div id="last-summary" class="font-semibold">Belum ada perhitungan</div>
            </div>
            <div class="text-right muted">
              <div id="last-distance">— km</div>
              <div id="last-emission">— kg CO₂</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- FULLSCREEN AR LAYER (hidden until open) -->
  <div id="ar-fullscreen" aria-hidden="true">
    <div id="ar-inner" class="fade-in">
      <div class="ar-top glass">
        <div class="flex items-center gap-3">
          <button id="exit-ar" class="btn btn-ghost">Keluar</button>
          <div id="ar-title" class="font-semibold">Objek AR</div>
          <div class="muted" id="ar-sub">—</div>
        </div>
        <div class="ar-controls">
          <button id="ar-sampai" class="btn btn-primary">Sampai</button>
        </div>
      </div>

      <!-- model-viewer - covers remaining area -->
      <model-viewer id="model-viewer"
                    camera-controls
                    environment-image="neutral"
                    shadow-intensity="1"
                    interaction-prompt="auto"
                    ar
                    ar-modes="webxr scene-viewer quick-look"
                    style="background:transparent;">
      </model-viewer>
    </div>
  </div>

<script>
/* =========================
   GeoEmisi AR — Fullscreen AR
   - CSV: only name + url(.glb)
   - When user clicks "Pilih": record current geolocation as START (object's world coordinate)
   - "Lihat Objek": open fullscreen AR (hide map/other UI). model-viewer handles AR placement on real ground.
   - "Sampai" (in fullscreen AR or floating): record current geolocation as END, compute distance & emission
   ========================= */

/* CONFIG */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';
const EMISSION_FACTORS = { motor:120, mobil:200, truk:900 };

/* STATE */
let items = [];           // {id, title, url, lat?, lng?, startRecorded}
let selected = null;
let startPoint = null;
let endPoint = null;
let currentPosition = null;

/* UI refs */
const statusEl = document.getElementById('status');
const objectListEl = document.getElementById('object-list');
const cameraVideo = document.getElementById('camera-feed');
const modelViewer = document.getElementById('model-viewer');
const arFullscreen = document.getElementById('ar-fullscreen');
const arTitle = document.getElementById('ar-title');
const arSub = document.getElementById('ar-sub');
const exitArBtn = document.getElementById('exit-ar');
const arSampaiBtn = document.getElementById('ar-sampai');
const btnSampaiFloating = document.getElementById('btn-sampai-floating');
const vehicleSelect = document.getElementById('vehicle-select');
const lastSummary = document.getElementById('last-summary');
const lastDistance = document.getElementById('last-distance');
const lastEmission = document.getElementById('last-emission');
const selectedChip = document.getElementById('selected-chip');
const refreshCsvBtn = document.getElementById('refresh-csv');
const centerMeBtn = document.getElementById('center-me');
const openMapBtn = document.getElementById('open-map-btn');

/* MAP */
let map = null;
let leafletMarkers = {};

/* UTIL: parse CSV (name/url) robustly */
function parseCSV(text){
  const lines = text.trim().split('\n').filter(Boolean);
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('nama') || h.includes('title'));
  const urlIdx = headers.findIndex(h => h.includes('url') || h.includes('glb') || h.includes('model') || h.includes('link'));
  if(nameIdx === -1 || urlIdx === -1) throw new Error('CSV harus memiliki kolom name dan url');
  const rows = [];
  for(let i=1;i<lines.length;i++){
    // naive split but fine for simple CSV from Sheets
    const parts = lines[i].split(',').map(p=>p.trim());
    if(parts[nameIdx] && parts[urlIdx]) rows.push({ title: parts[nameIdx], url: parts[urlIdx] });
  }
  return rows;
}

/* Haversine (meters) */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const toRad = v => v * Math.PI / 180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2 - lat1), Δλ = toRad(lon2 - lon1);
  const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* bearing (deg) */
function bearing(lat1, lon1, lat2, lon2){
  const toRad = v => v * Math.PI/180, toDeg = v=>v*180/Math.PI;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x)) + 360) % 360;
}

/* CSV load */
async function loadCSV(){
  statusEl.textContent = 'Memuat CSV...';
  try{
    const r = await fetch(CSV_URL);
    if(!r.ok) throw new Error('Gagal fetch CSV');
    const txt = await r.text();
    const rows = parseCSV(txt);
    // map rows -> items
    items = rows.map((r,i)=>({ id:`obj_${i}`, title:r.title, url:r.url, startRecorded:false }));
    statusEl.textContent = `Memuat ${items.length} objek`;
    renderList();
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Gagal memuat CSV. Pastikan publik.';
  }
}

/* render list */
function renderList(){
  objectListEl.innerHTML = '';
  items.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'obj-row';
    div.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div class="font-semibold">${item.title}</div>
        <div class="muted text-xs">${(item.url||'').split('/').pop()}</div>
      </div>
      <div class="flex flex-col gap-2" style="min-width:120px;align-items:flex-end;">
        <div style="display:flex; gap:8px;">
          <button data-id="${item.id}" class="btn btn-ghost btn-select">Pilih</button>
          <button data-id="${item.id}" class="btn btn-primary btn-view">Lihat</button>
        </div>
        <div class="muted text-xs">${item.startRecorded? 'Start tercatat':''}</div>
      </div>
    `;
    objectListEl.appendChild(div);
  });

  // listeners
  document.querySelectorAll('.btn-select').forEach(b=>{
    b.addEventListener('click', async (e)=>{
      const id = e.currentTarget.dataset.id;
      await handleSelect(id);
    });
  });
  document.querySelectorAll('.btn-view').forEach(b=>{
    b.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id;
      handleView(id);
    });
  });
}

/* select: record start using geolocation */
async function handleSelect(id){
  const obj = items.find(i=>i.id===id);
  if(!obj) return;
  statusEl.textContent = 'Mencatat lokasi start...';
  try{
    const pos = await getCurrentPosition({ enableHighAccuracy:true, timeout:12000 });
    obj.lat = pos.coords.latitude;
    obj.lng = pos.coords.longitude;
    obj.startRecorded = true;
    startPoint = { lat: obj.lat, lng: obj.lng, time: Date.now(), objectId: obj.id };
    selected = obj;
    statusEl.textContent = `Dipilih: ${obj.title} • (${obj.lat.toFixed(5)}, ${obj.lng.toFixed(5)})`;
    selectedChip.textContent = `${obj.title} • start tercatat`;
    placeMarker(obj);
    // center map
    if(map) map.setView([obj.lat, obj.lng], 17);
    renderList();
  }catch(err){
    alert('Gagal ambil lokasi. Aktifkan izin lokasi di browser.');
    console.error(err);
    statusEl.textContent = 'Gagal mencatat start';
  }
}

/* view: open fullscreen AR modal, hide map area */
function handleView(id){
  const obj = items.find(i=>i.id===id);
  if(!obj) return;
  // ensure model url present
  modelViewer.setAttribute('src', obj.url);
  arTitle.textContent = obj.title;
  arSub.textContent = (obj.startRecorded ? `Start: ${obj.lat.toFixed(5)}, ${obj.lng.toFixed(5)}` : 'Start belum dicatat');
  // show fullscreen AR overlay
  openARFullscreen();
  // set selected as this object (but do not force start if not recorded)
  selected = obj;
}

/* open AR fullscreen: hide map & UI that could obstruct, show ar-fullscreen */
function openARFullscreen(){
  // hide elements that should not cover AR
  document.querySelectorAll('.hide-when-ar').forEach(el=>el.style.opacity = '0');
  document.querySelector('.app-shell').style.filter = 'blur(0.6px)';
  arFullscreen.style.display = 'flex';
  arFullscreen.setAttribute('aria-hidden','false');
  // request full-screen for immersive feel (best-effort)
  try { document.documentElement.requestFullscreen?.(); } catch(e){}
}

/* close AR */
function closeARFullscreen(){
  arFullscreen.style.display = 'none';
  document.querySelectorAll('.hide-when-ar').forEach(el=>el.style.opacity = '');
  document.querySelector('.app-shell').style.filter = '';
  arFullscreen.setAttribute('aria-hidden','true');
  try { if(document.fullscreenElement) document.exitFullscreen?.(); } catch(e){}
}

/* button events */
exitArBtn.addEventListener('click', ()=> closeARFullscreen());
document.getElementById('refresh-csv').addEventListener('click', loadCSV);
openMapBtn.addEventListener('click', ()=> {
  // scroll to map
  document.getElementById('student-map').scrollIntoView({behavior:'smooth'});
});
centerMeBtn.addEventListener('click', ()=> {
  if(currentPosition && map) map.setView([currentPosition.lat, currentPosition.lng], 17);
});

/* Sampai handlers (both floating and AR top) */
btnSampaiFloating.addEventListener('click', doSampai);
arSampaiBtn.addEventListener('click', ()=>{
  doSampai().then(()=> closeARFullscreen());
});

/* doSampai: capture current location as END -> compute distance & emission */
async function doSampai(){
  if(!selected || !selected.startRecorded){
    alert('Belum ada objek yang dipilih & start belum tercatat.');
    return;
  }
  statusEl.textContent = 'Mencatat lokasi sampai...';
  try{
    const pos = await getCurrentPosition({ enableHighAccuracy:true, timeout:12000 });
    endPoint = { lat: pos.coords.latitude, lng: pos.coords.longitude, time: Date.now() };
    // compute distance
    const meters = distanceMeters(selected.lat, selected.lng, endPoint.lat, endPoint.lng);
    const km = meters / 1000;
    const vehicle = vehicleSelect.value || 'mobil';
    const factor = EMISSION_FACTORS[vehicle] || EMISSION_FACTORS.mobil;
    const grams = km * factor;
    const kilos = grams / 1000;
    // update UI
    lastSummary.textContent = `${selected.title} → ${vehicle}`;
    lastDistance.textContent = `${km.toFixed(3)} km`;
    lastEmission.textContent = `${kilos.toFixed(3)} kg CO₂`;
    statusEl.textContent = `Selesai — ${km.toFixed(3)} km • ${kilos.toFixed(3)} kg CO₂`;
    // place end marker and polyline
    if(map){
      if(leafletMarkers['end']) map.removeLayer(leafletMarkers['end']);
      leafletMarkers['end'] = L.marker([endPoint.lat, endPoint.lng]).addTo(map).bindPopup('Sampai');
      if(leafletMarkers['route']) map.removeLayer(leafletMarkers['route']);
      const pl = L.polyline([[selected.lat, selected.lng],[endPoint.lat, endPoint.lng]], { color:'#7c3aed' }).addTo(map);
      leafletMarkers['route'] = pl;
      map.fitBounds(pl.getBounds(), { padding:[40,40] });
    }
    return { meters, km, grams, kilos };
  }catch(err){
    alert('Gagal mencatat lokasi sampai — aktifkan izin lokasi.');
    console.error(err);
    statusEl.textContent = 'Gagal mencatat sampai';
  }
}

/* geolocation helper (promise) */
function getCurrentPosition(opts){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error('Geolocation tidak tersedia'));
    navigator.geolocation.getCurrentPosition(resolve, reject, opts);
  });
}

/* start camera preview (for mobile quick preview) */
async function startCamera(){
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
      cameraVideo.srcObject = stream;
    }catch(err){
      console.warn('camera error', err);
    }
  }
}

/* Map init */
function initMap(){
  map = L.map('student-map', { zoomControl:true }).setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

/* place marker for object start */
function placeMarker(obj){
  if(!map) return;
  if(leafletMarkers[obj.id]) map.removeLayer(leafletMarkers[obj.id]);
  leafletMarkers[obj.id] = L.marker([obj.lat, obj.lng]).addTo(map).bindPopup(`<b>${obj.title}</b><br>Start`);
}

/* watch position - update currentPosition */
function startPositionWatch(){
  if(!navigator.geolocation) return;
  navigator.geolocation.watchPosition(p=>{
    currentPosition = { lat:p.coords.latitude, lng:p.coords.longitude, accuracy:p.coords.accuracy };
    // if no selection, center map to user
    if(map && (!selected || !selected.startRecorded)) map.setView([currentPosition.lat, currentPosition.lng], 17);
  }, err=> console.warn('watch error',err), { enableHighAccuracy:true, maximumAge:1500, timeout:8000 });
}

/* boot */
(async function boot(){
  initMap();
  await loadCSV();
  await startCamera();
  startPositionWatch();
  statusEl.textContent = 'Siap — pilih objek untuk mulai.';
})();

</script>
</body>
</html>
