<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>GeoEmisi AR ‚Äî Simulasi Jejak Karbon</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Import model-viewer untuk 3D models -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body { 
      font-family: 'Poppins', sans-serif; 
      margin: 0; 
      padding: 0;
      overflow: hidden;
      background: #000;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    .overlay-ui { 
      position: fixed; 
      bottom: 8px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: rgba(255,255,255,0.98); 
      padding: 12px 16px; 
      border-radius: 16px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
      z-index: 20; 
      width: calc(100% - 32px); 
      max-width: 400px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .hud-info { 
      position: fixed; 
      top: env(safe-area-inset-top, 12px); 
      left: 50%; 
      transform: translateX(-50%); 
      background: rgba(255,255,255,0.98); 
      padding: 10px 16px; 
      border-radius: 12px; 
      z-index: 20; 
      text-align: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .status-dot { 
      display:inline-block; 
      width:10px; 
      height:10px; 
      border-radius:50%; 
      margin-right:8px; 
      vertical-align:middle; 
    }
    
    .camera-container { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 10; 
    }
    
    .camera-feed { 
      width: 100%; 
      height: 100%; 
      object-fit: cover;
    }
    
    .ar-overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none; 
      z-index: 15; 
    }
    
    /* WORLD-ANCHORED AR OBJECT */
    .world-object { 
      position: absolute;
      transform-style: preserve-3d;
      pointer-events: auto;
      transition: transform 0.1s;
      will-change: transform;
    }
    
    .object-content {
      transform-style: preserve-3d;
      backface-visibility: hidden;
    }
    
    .model-viewer-3d {
      width: 300px;
      height: 300px;
      background: transparent;
    }
    
    .image-object {
      max-width: 400px;
      max-height: 400px;
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      border: 3px solid white;
    }
    
    .placeholder-object {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      border: 3px solid white;
      text-align: center;
      padding: 10px;
    }
    
    .object-label {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .object-distance {
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(59, 130, 246, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .ground-marker {
      position: absolute;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, rgba(34,197,94,0.8) 0%, rgba(34,197,94,0) 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite;
      pointer-events: none;
    }
    
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 100;
      padding: 20px;
      text-align: center;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .permission-btn {
      background: white;
      color: #2563eb;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: 600;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    
    .btn-mobile {
      padding: 14px 16px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      min-height: 48px;
    }
    
    select {
      font-size: 16px !important;
      padding: 12px !important;
      min-height: 48px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
    }
    
    @keyframes float {
      0% { transform: translate(-50%, -50%) translateY(0px); }
      50% { transform: translate(-50%, -50%) translateY(-10px); }
      100% { transform: translate(-50%, -50%) translateY(0px); }
    }
    
    /* Safe area support */
    .safe-top {
      padding-top: env(safe-area-inset-top);
    }
    
    .safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .error-screen {
      background: #dc2626;
      color: white;
    }

    /* Placement controls */
    .placement-controls {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 25;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .placement-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.95);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      font-size: 20px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <h2 class="text-xl font-bold mb-2">GeoEmisi AR</h2>
    <p id="loading-status" class="text-lg mb-4">Menyiapkan aplikasi...</p>
    <button id="retry-btn" class="permission-btn hidden" onclick="retryInitialization()">Coba Lagi</button>
    <button id="camera-permission-btn" class="permission-btn hidden" onclick="requestCameraPermission()">Izinkan Kamera</button>
  </div>

  <!-- Camera View -->
  <div class="camera-container">
    <video id="camera-feed" class="camera-feed" autoplay playsinline muted></video>
    <div class="ar-overlay" id="ar-overlay"></div>
    
    <!-- Placement Controls -->
    <div class="placement-controls">
      <button id="btnMoveLeft" class="placement-btn">‚¨ÖÔ∏è</button>
      <button id="btnMoveRight" class="placement-btn">‚û°Ô∏è</button>
      <button id="btnMoveUp" class="placement-btn">‚¨ÜÔ∏è</button>
      <button id="btnMoveDown" class="placement-btn">‚¨áÔ∏è</button>
      <button id="btnScaleUp" class="placement-btn">‚ûï</button>
      <button id="btnScaleDown" class="placement-btn">‚ûñ</button>
    </div>
  </div>

  <!-- HUD GPS Status -->
  <div class="hud-info safe-top">
    <span id="gpsDot" class="status-dot" style="background:#f59e0b"></span>
    <span id="gpsText">üì° Mendeteksi lokasi...</span>
  </div>

  <!-- Panel Kontrol -->
  <div class="overlay-ui safe-bottom">
    <div class="flex flex-col gap-3">
      <div>
        <label class="text-xs text-gray-600 block mb-2">Pilih Objek AR</label>
        <select id="objectSelect" class="w-full border-2 border-gray-200 rounded-xl px-3 py-3 bg-white">
          <option value="">-- pilih objek --</option>
        </select>
      </div>
      
      <div class="flex gap-2">
        <button id="btnPlace" class="flex-1 bg-blue-600 text-white rounded-xl btn-mobile">
          Letakkan di Tanah
        </button>
        <button id="btnStart" class="flex-1 bg-emerald-500 text-white rounded-xl btn-mobile">
          Start
        </button>
        <button id="btnFinish" class="flex-1 bg-red-500 text-white rounded-xl btn-mobile" disabled>
          Finish
        </button>
      </div>
      
      <div>
        <label class="text-xs text-gray-600 block mb-2">Mode Transportasi</label>
        <select id="transportMode" class="w-full border-2 border-gray-200 rounded-xl px-3 py-3 bg-white">
          <option value="motor">Motor Pribadi</option>
          <option value="mobil">Mobil Pribadi</option>
          <option value="umum">Angkutan Umum</option>
          <option value="truk">Truk</option>
        </select>
      </div>
      
      <div class="text-sm text-gray-800 mt-2 bg-gray-50 rounded-xl p-3">
        <div class="flex justify-between items-center mb-2">
          <span>Jarak tempuh:</span>
          <strong id="distVal" class="text-blue-600">0.00 km</strong>
        </div>
        <div class="flex justify-between items-center">
          <span>Emisi CO‚ÇÇ:</span>
          <strong id="emisVal" class="text-red-600">0.00 kg</strong>
        </div>
      </div>
      
      <div class="text-xs text-gray-500 text-center mt-2">
        Arahkan kamera ke tanah, lalu tap "Letakkan di Tanah"
      </div>
    </div>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';
    const emissionFactors = { motor: 0.1, mobil: 0.25, umum: 0.05, truk: 0.4 };

    let objects = [];
    let currentPosition = null;
    let watchId = null;
    let simActive = false;
    let simStartPos = null;
    let simDist = 0;
    let cameraStream = null;
    let currentObject = null;
    let currentObjectName = '';
    let initializationAttempts = 0;
    
    // AR World State
    let arWorldState = {
      objects: [],
      groundPlane: null,
      deviceOrientation: { alpha: 0, beta: 0, gamma: 0 },
      screenCenter: { x: 0, y: 0 }
    };
    
    // Object placement state
    let placementState = {
      isPlacing: false,
      currentPosition: { x: 50, y: 50 }, // % based coordinates
      currentScale: 1.0,
      baseSize: 300
    };

    // Parse CSV data
    function parseCSV(text) {
      try {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.toLowerCase().trim());
        const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('nama'));
        const urlIdx = headers.findIndex(h => h.includes('url'));
        
        return lines.slice(1).map(l => {
          const cols = l.split(',').map(c => c.trim());
          return { 
            name: cols[nameIdx] || 'Unnamed', 
            url: cols[urlIdx] || '' 
          };
        }).filter(obj => obj.url);
      } catch (e) {
        console.error('CSV parsing error:', e);
        return [];
      }
    }

    // Load CSV data
    async function loadCSV() {
      try {
        updateLoadingStatus('Memuat data objek...');
        const res = await fetch(csvUrl);
        const text = await res.text();
        objects = parseCSV(text);
        
        const sel = document.getElementById('objectSelect');
        sel.innerHTML = '<option value="">-- pilih objek --</option>';
        
        objects.forEach((o, i) => {
          const opt = document.createElement('option'); 
          opt.value = i; 
          opt.textContent = o.name; 
          sel.appendChild(opt);
        });
        
        return objects.length > 0;
      } catch (e) {
        console.error('Failed to load CSV:', e);
        // Fallback objects
        objects = [
          { name: "Pohon 3D", url: "https://cdn.glitch.global/7c71a2b3-0d3e-4b0e-9b4a-5a5a5a5a5a5a/tree.glb" },
          { name: "Mobil Listrik", url: "https://cdn.glitch.global/7c71a2b3-0d3e-4b0e-9b4a-5a5a5a5a5a5a/electric-car.glb" },
          { name: "Gambar Solar Panel", url: "https://images.unsplash.com/photo-1509391366360-2e959784a276?w=400" }
        ];
        
        const sel = document.getElementById('objectSelect');
        sel.innerHTML = '<option value="">-- pilih objek --</option>';
        objects.forEach((o, i) => {
          const opt = document.createElement('option'); 
          opt.value = i; 
          opt.textContent = o.name; 
          sel.appendChild(opt);
        });
        
        updateLoadingStatus('Menggunakan data offline...');
        return true;
      }
    }

    // Start camera
    async function startCamera() {
      try {
        updateLoadingStatus('Mengakses kamera...');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Browser tidak mendukung akses kamera');
        }

        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };

        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('camera-feed');
        
        return new Promise((resolve, reject) => {
          videoElement.srcObject = cameraStream;
          
          videoElement.onloadedmetadata = () => {
            videoElement.play().then(() => {
              // Initialize screen center
              arWorldState.screenCenter = {
                x: videoElement.videoWidth / 2,
                y: videoElement.videoHeight / 2
              };
              resolve(true);
            }).catch(reject);
          };
          
          videoElement.onerror = reject;
          
          setTimeout(() => resolve(true), 2000);
        });

      } catch (error) {
        console.error('Camera access error:', error);
        handleCameraError(error);
        return false;
      }
    }

    function handleCameraError(error) {
      let errorMessage = 'Tidak dapat mengakses kamera';
      let showPermissionButton = false;
      
      if (error.name === 'NotAllowedError') {
        errorMessage = 'Izin kamera ditolak. Tap tombol di bawah untuk mengizinkan.';
        showPermissionButton = true;
      } else if (error.name === 'NotFoundError') {
        errorMessage = 'Kamera tidak ditemukan di perangkat ini';
      } else if (error.name === 'NotSupportedError') {
        errorMessage = 'Browser tidak mendukung akses kamera';
      } else {
        errorMessage = 'Error kamera: ' + error.message;
      }
      
      updateLoadingStatus(errorMessage, true);
      if (showPermissionButton) {
        document.getElementById('camera-permission-btn').classList.remove('hidden');
      }
      document.getElementById('retry-btn').classList.remove('hidden');
    }

    // Place object in WORLD SPACE (not screen space)
    function placeObjectInWorld(url, objectName) {
      if (simActive) {
        alert('Tunggu simulasi selesai dulu sebelum mengganti objek!');
        return;
      }

      const overlay = document.getElementById('ar-overlay');
      
      // Clear existing objects
      clearAllObjects();
      
      // Create ground marker at screen center
      createGroundMarker();
      
      // Create world-anchored object
      currentObject = document.createElement('div');
      currentObject.className = 'world-object';
      currentObject.style.left = '50%';
      currentObject.style.top = '50%';
      currentObject.style.width = (placementState.baseSize * placementState.currentScale) + 'px';
      currentObject.style.height = (placementState.baseSize * placementState.currentScale) + 'px';
      currentObjectName = objectName;
      
      // Create object content based on type
      const content = createObjectContent(url, objectName);
      currentObject.appendChild(content);
      
      // Add object info
      addObjectInfo(currentObject, objectName);
      
      overlay.appendChild(currentObject);
      
      // Enable placement mode
      placementState.isPlacing = true;
      updatePlacementControls();
      
      console.log('Object placed in world space:', objectName);
    }

    function createObjectContent(url, objectName) {
      const content = document.createElement('div');
      content.className = 'object-content';
      
      if (url.toLowerCase().includes('.glb') || url.toLowerCase().includes('.gltf')) {
        // 3D Model with model-viewer
        const modelViewer = document.createElement('model-viewer');
        modelViewer.src = url;
        modelViewer.alt = objectName;
        modelViewer.autoRotate = true;
        modelViewer.cameraControls = true;
        modelViewer.shadowIntensity = 1;
        modelViewer.className = 'model-viewer-3d';
        modelViewer.style.width = '100%';
        modelViewer.style.height = '100%';
        content.appendChild(modelViewer);
        
      } else if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
        // Image object
        const img = document.createElement('img');
        img.src = url;
        img.alt = objectName;
        img.className = 'image-object';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.onerror = createFallbackContent;
        content.appendChild(img);
      } else {
        // Placeholder for other types
        createFallbackContent(content);
      }
      
      return content;
    }

    function createFallbackContent(container) {
      const placeholder = document.createElement('div');
      placeholder.className = 'placeholder-object';
      placeholder.innerHTML = 'üéÅ<div style="font-size:12px;margin-top:8px;">AR Object</div>';
      container.appendChild(placeholder);
    }

    function addObjectInfo(objectElement, objectName) {
      // Label
      const label = document.createElement('div');
      label.className = 'object-label';
      label.textContent = objectName;
      objectElement.appendChild(label);
      
      // Distance indicator
      const distance = document.createElement('div');
      distance.className = 'object-distance';
      distance.textContent = 'Tap & drag untuk memindahkan';
      objectElement.appendChild(distance);
      
      // Make object draggable
      makeObjectDraggable(objectElement);
    }

    function createGroundMarker() {
      const overlay = document.getElementById('ar-overlay');
      const marker = document.createElement('div');
      marker.className = 'ground-marker';
      marker.style.left = '50%';
      marker.style.top = '50%';
      marker.id = 'ground-marker';
      overlay.appendChild(marker);
    }

    function makeObjectDraggable(objectElement) {
      let isDragging = false;
      let startX, startY, initialX, initialY;
      
      objectElement.addEventListener('touchstart', (e) => {
        if (!placementState.isPlacing) return;
        
        isDragging = true;
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        
        const style = window.getComputedStyle(objectElement);
        initialX = parseInt(style.left);
        initialY = parseInt(style.top);
        
        e.preventDefault();
      });
      
      objectElement.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;
        
        const newX = initialX + (deltaX / window.innerWidth) * 100;
        const newY = initialY + (deltaY / window.innerHeight) * 100;
        
        // Constrain to screen bounds
        objectElement.style.left = Math.max(10, Math.min(90, newX)) + '%';
        objectElement.style.top = Math.max(10, Math.min(90, newY)) + '%';
        
        // Update placement state
        placementState.currentPosition.x = parseFloat(objectElement.style.left);
        placementState.currentPosition.y = parseFloat(objectElement.style.top);
        
        e.preventDefault();
      });
      
      objectElement.addEventListener('touchend', () => {
        isDragging = false;
      });
    }

    // Placement control functions
    function setupPlacementControls() {
      document.getElementById('btnMoveLeft').addEventListener('click', () => moveObject(-5, 0));
      document.getElementById('btnMoveRight').addEventListener('click', () => moveObject(5, 0));
      document.getElementById('btnMoveUp').addEventListener('click', () => moveObject(0, -5));
      document.getElementById('btnMoveDown').addEventListener('click', () => moveObject(0, 5));
      document.getElementById('btnScaleUp').addEventListener('click', () => scaleObject(0.2));
      document.getElementById('btnScaleDown').addEventListener('click', () => scaleObject(-0.2));
    }

    function moveObject(deltaX, deltaY) {
      if (!currentObject || !placementState.isPlacing) return;
      
      placementState.currentPosition.x = Math.max(10, Math.min(90, placementState.currentPosition.x + deltaX));
      placementState.currentPosition.y = Math.max(10, Math.min(90, placementState.currentPosition.y + deltaY));
      
      currentObject.style.left = placementState.currentPosition.x + '%';
      currentObject.style.top = placementState.currentPosition.y + '%';
    }

    function scaleObject(delta) {
      if (!currentObject || !placementState.isPlacing) return;
      
      placementState.currentScale = Math.max(0.3, Math.min(3, placementState.currentScale + delta));
      
      const size = placementState.baseSize * placementState.currentScale;
      currentObject.style.width = size + 'px';
      currentObject.style.height = size + 'px';
    }

    function updatePlacementControls() {
      const controls = document.querySelector('.placement-controls');
      controls.style.display = placementState.isPlacing ? 'flex' : 'none';
    }

    function clearAllObjects() {
      const overlay = document.getElementById('ar-overlay');
      overlay.innerHTML = '';
      currentObject = null;
      placementState.isPlacing = false;
      updatePlacementControls();
    }

    function finalizeObjectPlacement() {
      if (!currentObject) return;
      
      // Remove ground marker
      const marker = document.getElementById('ground-marker');
      if (marker) marker.remove();
      
      // Disable placement mode
      placementState.isPlacing = false;
      updatePlacementControls();
      
      // Update object label
      const label = currentObject.querySelector('.object-label');
      const distance = currentObject.querySelector('.object-distance');
      
      if (label) label.textContent = currentObjectName;
      if (distance) {
        distance.textContent = 'Diam di tanah';
        distance.style.background = 'rgba(34, 197, 94, 0.9)';
      }
      
      console.log('Object placement finalized at:', placementState.currentPosition);
    }

    // Start location tracking
    function startWatch() {
      if (!navigator.geolocation) {
        updateGPSStatus(false, '‚ùå GPS tidak didukung');
        return;
      }
      
      updateGPSStatus(false, 'üì° Mendeteksi lokasi...');
      
      watchId = navigator.geolocation.watchPosition(
        position => {
          currentPosition = {
            lat: position.coords.latitude, 
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          
          updateGPSStatus(true, `üìç GPS aktif (¬±${Math.round(currentPosition.accuracy)}m)`);
          
          if (simActive && simStartPos) {
            const d = haversine(simStartPos, currentPosition);
            simDist = d / 1000;
            updateDistanceDisplay();
          }
        }, 
        error => {
          console.error('GPS Error:', error);
          handleGPSError(error);
        }, 
        {
          enableHighAccuracy: true,
          maximumAge: 10000,
          timeout: 15000
        }
      );
    }

    function handleGPSError(error) {
      let errorMsg = 'Gagal mendapatkan lokasi';
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg = 'Izin lokasi ditolak. Aktifkan di pengaturan.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg = 'Lokasi tidak tersedia';
          break;
        case error.TIMEOUT:
          errorMsg = 'Timeout mendapatkan lokasi';
          break;
      }
      
      updateGPSStatus(false, errorMsg);
    }

    // Update distance and emission display
    function updateDistanceDisplay() {
      document.getElementById('distVal').textContent = simDist.toFixed(2);
      const mode = document.getElementById('transportMode').value;
      const emisi = simDist * (emissionFactors[mode] || 0);
      document.getElementById('emisVal').textContent = emisi.toFixed(2);
    }

    // Update GPS status display
    function updateGPSStatus(ok, text) {
      const dot = document.getElementById('gpsDot');
      const t = document.getElementById('gpsText');
      dot.style.background = ok ? '#16a34a' : '#f59e0b';
      t.textContent = text;
    }

    // Update loading status
    function updateLoadingStatus(text, isError = false) {
      const statusElement = document.getElementById('loading-status');
      const loadingScreen = document.getElementById('loading-screen');
      
      statusElement.textContent = text;
      
      if (isError) {
        loadingScreen.classList.add('error-screen');
      } else {
        loadingScreen.classList.remove('error-screen');
      }
    }

    // Haversine distance calculation
    function haversine(a, b) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
      return R * c;
    }

    // Request camera permission
    async function requestCameraPermission() {
      try {
        document.getElementById('camera-permission-btn').classList.add('hidden');
        updateLoadingStatus('Meminta izin kamera...');
        
        await navigator.mediaDevices.getUserMedia({ video: true });
        retryInitialization();
      } catch (error) {
        updateLoadingStatus('Izin kamera masih ditolak', true);
        document.getElementById('camera-permission-btn').classList.remove('hidden');
      }
    }

    // Retry initialization
    function retryInitialization() {
      initializationAttempts++;
      document.getElementById('retry-btn').classList.add('hidden');
      document.getElementById('camera-permission-btn').classList.add('hidden');
      
      if (initializationAttempts >= 3) {
        updateLoadingStatus('Gagal memulai aplikasi. Silakan refresh halaman.', true);
        return;
      }
      
      initApp();
    }

    // Initialize app
    async function initApp() {
      try {
        updateLoadingStatus('Memulai aplikasi...');
        
        const cameraSuccess = await startCamera();
        if (!cameraSuccess) return;
        
        const csvSuccess = await loadCSV();
        if (!csvSuccess) {
          updateLoadingStatus('Menggunakan data offline...');
        }
        
        startWatch();
        setupPlacementControls();
        
        setTimeout(() => {
          document.getElementById('loading-screen').style.display = 'none';
        }, 1000);
        
      } catch (error) {
        console.error('Initialization error:', error);
        updateLoadingStatus('Error: ' + error.message, true);
        document.getElementById('retry-btn').classList.remove('hidden');
      }
    }

    // Event listeners
    document.getElementById('btnPlace').addEventListener('click', () => {
      const idx = document.getElementById('objectSelect').value;
      if (idx === '') {
        alert('Pilih objek terlebih dahulu.');
        return;
      }
      const obj = objects[idx];
      placeObjectInWorld(obj.url, obj.name);
    });

    document.getElementById('btnStart').addEventListener('click', () => {
      if (!currentPosition) {
        alert('Menunggu GPS aktif...');
        return;
      }
      
      if (!currentObject) {
        alert('Letakkan objek AR terlebih dahulu!');
        return;
      }
      
      // Finalize object placement before starting simulation
      finalizeObjectPlacement();
      
      simStartPos = {...currentPosition};
      simDist = 0;
      simActive = true;
      document.getElementById('btnStart').disabled = true;
      document.getElementById('btnFinish').disabled = false;
      document.getElementById('btnPlace').disabled = true;
      document.getElementById('objectSelect').disabled = true;
      
      updateGPSStatus(true, 'üü¢ Simulasi aktif...');
      updateDistanceDisplay();
      
      // Update object appearance during simulation
      const label = currentObject.querySelector('.object-label');
      if (label) {
        label.textContent = `${currentObjectName} (Simulasi Aktif)`;
        label.style.background = 'rgba(34, 197, 94, 0.9)';
      }
    });

    document.getElementById('btnFinish').addEventListener('click', () => {
      if (!simActive) {
        alert('Simulasi belum dimulai');
        return;
      }
      
      const mode = document.getElementById('transportMode').value;
      const emisi = simDist * (emissionFactors[mode] || 0);
      
      if (window.confirm(`Simulasi selesai!\n\nJarak: ${simDist.toFixed(2)} km\nEmisi CO‚ÇÇ: ${emisi.toFixed(2)} kg\n\nHapus objek AR?`)) {
        clearAllObjects();
      }
      
      simActive = false;
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnFinish').disabled = true;
      document.getElementById('btnPlace').disabled = false;
      document.getElementById('objectSelect').disabled = false;
      
      updateGPSStatus(true, '‚úÖ Simulasi selesai');
    });

    // Start the application
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    // Clean up
    window.addEventListener('beforeunload', () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
  </script>
</body>
</html>
