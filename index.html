<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoEmisi AR â€” Kids Edition</title>

<!-- Simple styles (no Tailwind) -->
<style>
  :root{
    --bg:#e6f7ff;
    --card:#ffffff;
    --accent:#2b8cff;
    --accent-2:#7bd389;
    --muted:#5b6b7a;
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#023047;}
  .wrap{max-width:460px; margin:12px auto; padding:12px;}
  h1{margin:0 0 6px 0; font-size:20px;}
  p.lead{margin:0 0 12px 0; color:var(--muted); font-size:13px;}
  .card{background:var(--card); border-radius:12px; padding:10px; box-shadow:0 6px 18px rgba(2,16,40,0.06); margin-bottom:10px;}
  .row{display:flex; gap:8px; align-items:center;}
  .big-btn{flex:1; background:var(--accent); color:white; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 6px 14px rgba(43,140,255,0.18);}
  .ghost-btn{background:transparent; border:2px solid var(--accent); color:var(--accent); padding:10px; border-radius:10px; font-weight:700; cursor:pointer;}
  .small{font-size:13px; color:var(--muted);}
  #object-list{max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:8px;}
  .obj{display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background:linear-gradient(180deg, #fff, #f7fdff);}
  .obj .title{font-weight:700;}
  .controls{display:flex; gap:8px; margin-top:8px; align-items:center;}
  select{padding:8px; border-radius:8px; border:1px solid #dbeffd;}
  #map{height:150px; border-radius:10px; overflow:hidden; margin-top:8px;}
  /* Camera preview */
  #preview{height:320px; border-radius:12px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative;}
  #camera { width:100%; height:100%; object-fit:cover; }
  .overlay-top{position:absolute; top:8px; left:8px; right:8px; display:flex; justify-content:space-between; pointer-events:none;}
  .chip{background:rgba(255,255,255,0.9); padding:6px 8px; border-radius:999px; font-weight:700; pointer-events:auto;}
  .floating-sampai{position:absolute; bottom:12px; left:50%; transform:translateX(-50%); pointer-events:auto;}
  .emission{display:flex; gap:8px; align-items:center;}
  .cloud{width:56px; height:56px; display:flex; align-items:center; justify-content:center; border-radius:999px; background:linear-gradient(180deg,#fff,#f0f8ff); box-shadow:0 6px 18px rgba(2,16,40,0.06);}
  .result-big{font-size:18px; font-weight:800; color:#023047;}
  .muted{color:var(--muted); font-size:13px;}
  /* Fullscreen AR modal */
  #ar-modal{position:fixed; inset:0; background:#000; display:none; z-index:9999; align-items:center; justify-content:center;}
  #ar-topbar{position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; pointer-events:none;}
  .ar-btn{pointer-events:auto; background:rgba(255,255,255,0.9); padding:8px 10px; border-radius:10px; font-weight:800; border:none; cursor:pointer;}
  .ar-sampai{background:var(--accent-2); color:white;}
  /* responsive small */
  @media (max-width:420px){ .wrap{padding:8px;} h1{font-size:18px;} }
</style>

<!-- model-viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

</head>
<body>
  <div class="wrap">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
      <div class="cloud" aria-hidden="true">
        <!-- simple cloud icon -->
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 17H6a4 4 0 010-8 5 5 0 019.9-1.2A3.5 3.5 0 0119 11.5 3.5 3.5 0 0119 17z" fill="#7dd3fc"/></svg>
      </div>
      <div>
        <h1>GeoEmisi AR (Kids)</h1>
        <p class="lead">Pilih objek, lihat di dunia nyata, ketuk <strong>Sampai</strong> untuk lihat emisi.</p>
      </div>
    </div>

    <!-- camera preview -->
    <div class="card" id="preview">
      <video id="camera" autoplay playsinline muted></video>

      <div class="overlay-top">
        <div class="chip" id="chip-selected">Belum pilih</div>
        <div style="display:flex; gap:8px;">
          <button class="ghost-btn" id="btn-center" style="pointer-events:auto;">Saya</button>
          <button class="ghost-btn" id="btn-refresh" style="pointer-events:auto;">Muat Ulang</button>
        </div>
      </div>

      <div class="floating-sampai">
        <button id="btn-sampai" class="big-btn">Sampai âœ…</button>
      </div>
    </div>

    <!-- list + controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div><strong>Pilih Kendaraan</strong><div class="muted">Pilih satu dulu</div></div>
        <div>
          <select id="vehicle">
            <option value="motor">ðŸ›µ Motor</option>
            <option value="mobil" selected>ðŸš— Mobil</option>
            <option value="truk">ðŸšš Truk</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="small" style="margin-bottom:6px;"><strong>Daftar Objek</strong></div>
        <div id="object-list" aria-live="polite"></div>
      </div>

      <div id="map" style="margin-top:10px;"></div>
    </div>

    <!-- result -->
    <div class="card row" style="justify-content:space-between; align-items:center;">
      <div class="emission">
        <div class="cloud" aria-hidden="true">
          <!-- carbon cloud icon -->
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10" stroke="#60a5fa" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="17" cy="17" r="3" fill="#a7f3d0"/></svg>
        </div>
        <div style="margin-left:8px;">
          <div class="muted">Hasil Emisi</div>
          <div id="result-text" class="result-big">Belum ada</div>
        </div>
      </div>

      <div style="text-align:right;">
        <div class="muted">Jarak</div>
        <div id="result-distance" style="font-weight:800; font-size:18px;">-</div>
      </div>
    </div>

  </div>

  <!-- Fullscreen AR modal (kamera fullscreen + model-viewer) -->
  <div id="ar-modal" role="dialog" aria-hidden="true">
    <!-- top controls -->
    <div id="ar-topbar">
      <button id="ar-exit" class="ar-btn">Keluar âœ–</button>
      <div style="display:flex; gap:8px;">
        <button id="ar-sampai-btn" class="ar-btn ar-sampai">Sampai âœ…</button>
      </div>
    </div>

    <!-- model viewer fills screen -->
    <model-viewer id="mv"
      camera-controls
      ar
      ar-modes="webxr scene-viewer quick-look"
      interaction-prompt="auto"
      style="width:100vw; height:100vh; background:transparent;">
    </model-viewer>
  </div>

<script>
/* GeoEmisi AR - Kids Edition
   - CSV with name,url (glb)
   - select -> record start (current geolocation)
   - view (open AR fullscreen) -> user can place model on ground; AR modal hides other UI
   - Sampai -> record end, compute distance & emission
*/

const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';
// simple emission factors (g CO2 / km)
const FACTORS = { motor:120, mobil:200, truk:900 };

/* state */
let items = [];            // {id,title,url,lat,lng,startRecorded}
let selected = null;
let startPoint = null;
let endPoint = null;

/* ui refs */
const objectList = document.getElementById('object-list');
const chipSelected = document.getElementById('chip-selected');
const mv = document.getElementById('mv');
const arModal = document.getElementById('ar-modal');
const arExit = document.getElementById('ar-exit');
const arSampaiBtn = document.getElementById('ar-sampai-btn');
const btnSampai = document.getElementById('btn-sampai');
const vehicle = document.getElementById('vehicle');
const resultText = document.getElementById('result-text');
const resultDistance = document.getElementById('result-distance');
const btnRefresh = document.getElementById('btn-refresh');
const btnCenter = document.getElementById('btn-center');

const cameraEl = document.getElementById('camera');

/* map init */
let map = null;
let markers = {};
function initMap(){
  map = L.map('map', { zoomControl:false }).setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(map);
}

/* parse csv (simple) */
function parseCSV(text){
  const rows = text.trim().split('\\n').filter(Boolean);
  const headers = rows[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.findIndex(h=>h.includes('name') || h.includes('nama') || h.includes('title'));
  const urlIdx = headers.findIndex(h=>h.includes('url') || h.includes('glb') || h.includes('model') || h.includes('link'));
  if(nameIdx === -1 || urlIdx === -1) throw new Error('CSV harus berisi name dan url');
  const data = [];
  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(',').map(c=>c.trim());
    if(cols[nameIdx] && cols[urlIdx]) data.push({ id:'i'+i, title:cols[nameIdx], url:cols[urlIdx], startRecorded:false });
  }
  return data;
}

/* load csv and render list */
async function loadCSV(){
  try{
    const r = await fetch(CSV_URL);
    const txt = await r.text();
    items = parseCSV(txt);
    renderList();
  }catch(e){
    objectList.innerHTML = '<div class="small muted">Gagal memuat CSV.</div>';
    console.error(e);
  }
}

function renderList(){
  objectList.innerHTML = '';
  if(items.length===0){ objectList.innerHTML = '<div class="muted small">Tidak ada objek</div>'; return; }
  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'obj';
    el.innerHTML = `
      <div style="min-width:0">
        <div class="title">${it.title}</div>
        <div class="muted small">${it.startRecorded? 'Start tercatat':'Klik Pilih untuk catat start'}</div>
      </div>
      <div style="display:flex; gap:6px;">
        <button data-id="${it.id}" class="ghost-btn select-btn">Pilih</button>
        <button data-id="${it.id}" class="big-btn view-btn">Lihat</button>
      </div>
    `;
    objectList.appendChild(el);
  });

  document.querySelectorAll('.select-btn').forEach(b=>{
    b.addEventListener('click', async (ev)=>{
      const id = ev.currentTarget.dataset.id;
      await handleSelect(id);
    });
  });
  document.querySelectorAll('.view-btn').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const id = ev.currentTarget.dataset.id;
      handleView(id);
    });
  });
}

/* helper: geolocation promise */
function getGeo(opts={}) {
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej(new Error('No geolocation'));
    navigator.geolocation.getCurrentPosition(res,rej,opts);
  });
}

/* select -> record start */
async function handleSelect(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  try{
    const pos = await getGeo({ enableHighAccuracy:true, timeout:12000 });
    it.lat = pos.coords.latitude;
    it.lng = pos.coords.longitude;
    it.startRecorded = true;
    startPoint = { lat:it.lat, lng:it.lng, id:it.id, time:Date.now() };
    selected = it;
    chipSelected.textContent = it.title + ' â€¢ Start dicatat';
    placeMarkerStart(it);
    // center map
    if(map) map.setView([it.lat, it.lng], 16);
    renderList();
  }catch(e){
    alert('Gagal merekam lokasi. Pastikan izin lokasi diaktifkan.');
    console.error(e);
  }
}

/* view -> open AR fullscreen modal */
function handleView(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  selected = it;
  if(it.startRecorded) chipSelected.textContent = it.title + ' â€¢ Start tercatat';
  else chipSelected.textContent = it.title + ' â€¢ Start belum dicatat';
  // set model src and open modal
  mv.setAttribute('src', it.url);
  openAR();
}

/* open AR: show modal, request fullscreen for immersive feel */
function openAR(){
  arModal.style.display = 'flex';
  arModal.setAttribute('aria-hidden','false');
  try{ document.documentElement.requestFullscreen?.(); }catch(e){}
}

/* close AR */
function closeAR(){
  arModal.style.display = 'none';
  arModal.setAttribute('aria-hidden','true');
  try{ if(document.fullscreenElement) document.exitFullscreen?.(); }catch(e){}
}

/* Sampai: record end -> compute */
async function handleSampai(){
  if(!selected || !selected.startRecorded){
    alert('Pilih objek dan pastikan start sudah dicatat.');
    return;
  }
  try{
    const pos = await getGeo({ enableHighAccuracy:true, timeout:12000 });
    endPoint = { lat: pos.coords.latitude, lng: pos.coords.longitude, time:Date.now() };
    const meters = distance(selected.lat, selected.lng, endPoint.lat, endPoint.lng);
    const km = meters/1000;
    const veh = vehicle.value || 'mobil';
    const grams = km * (FACTORS[veh] || FACTORS.mobil);
    const kg = grams/1000;
    // show friendly strings
    resultText.textContent = `${kg.toFixed(3)} kg COâ‚‚`;
    resultDistance.textContent = `${km.toFixed(3)} km`;
    // place markers on map
    placeMarkerEnd(endPoint);
    drawRoute(selected, endPoint);
    // close AR if open
    closeAR();
  }catch(e){
    alert('Gagal merekam lokasi sampai. Pastikan izin lokasi.');
    console.error(e);
  }
}

/* compute haversine meters */
function distance(lat1, lon1, lat2, lon2){
  const R = 6371e3; const toRad = v=>v*Math.PI/180;
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2), Î”Ï† = toRad(lat2-lat1), Î”Î» = toRad(lon2-lon1);
  const a = Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2) + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* map helpers */
function placeMarkerStart(it){
  if(!map) return;
  if(markers[it.id]) map.removeLayer(markers[it.id]);
  markers[it.id] = L.marker([it.lat, it.lng]).addTo(map).bindPopup(it.title + ' (Start)');
}
function placeMarkerEnd(pt){
  if(!map) return;
  if(markers['end']) map.removeLayer(markers['end']);
  markers['end'] = L.marker([pt.lat, pt.lng], { opacity:0.9 }).addTo(map).bindPopup('Sampai');
}
function drawRoute(it, end){
  if(!map) return;
  if(markers['route']) map.removeLayer(markers['route']);
  const pl = L.polyline([[it.lat, it.lng],[end.lat, end.lng]], { color: '#2b8cff' }).addTo(map);
  markers['route'] = pl;
  map.fitBounds(pl.getBounds(), { padding:[20,20] });
}

/* camera preview start */
async function startCameraPreview(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    cameraEl.srcObject = s;
  }catch(e){
    // ignore if not allowed
    console.warn('camera preview failed', e);
  }
}

/* center map on user */
async function centerOnUser(){
  try{
    const p = await getGeo({ enableHighAccuracy:true, timeout:10000 });
    if(map) map.setView([p.coords.latitude, p.coords.longitude], 16);
  }catch(e){ console.warn(e); }
}

/* event bindings */
arExit.addEventListener('click', closeAR);
arSampaiBtn.addEventListener('click', handleSampai);
btnSampai.addEventListener('click', handleSampai);
btnRefresh.addEventListener('click', loadCSV);
btnCenter.addEventListener('click', centerOnUser);

/* boot */
(async function boot(){
  initMap();
  await loadCSV();
  await startCameraPreview();
  // try to center map on user soon
  try{ const p = await getGeo({ enableHighAccuracy:true, timeout:8000 }); map.setView([p.coords.latitude, p.coords.longitude], 15); } catch(e){}
})();

</script>
</body>
</html>
