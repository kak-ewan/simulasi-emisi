<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoEmisi AR</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- model-viewer for .glb & AR -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

<style>
  body { font-family: Inter, system-ui, -apple-system, "Poppins", sans-serif; background:#f0f9ff; }
  #student-mode { min-height:100vh; display:flex; flex-direction:column; }
  .camera-feed { position:relative; height:60vh; background:#000; overflow:hidden; border-radius:12px; }
  #camera-feed { width:100%; height:100%; object-fit:cover; }
  #ar-overlay { position:absolute; inset:0; pointer-events:none; z-index:20; }
  .controls { display:flex; gap:8px; align-items:center; }
  .panel { background:white; border-radius:12px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
  #student-map { height:35vh; border-radius:12px; }
  .hidden{display:none;}
</style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-2">GeoEmisi AR</h1>
    <p class="text-sm text-gray-600 mb-4">Pilih objek (.glb) — lokasi awal dicatat saat memilih. Lihat model di AR dan hitung emisi saat sampai.</p>

    <!-- Loading / status -->
    <div id="status" class="mb-3 panel">Memuat daftar objek...</div>

    <!-- Main layout -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Left column: camera / AR -->
      <div class="md:col-span-2">
        <div class="camera-feed panel">
          <video id="camera-feed" autoplay playsinline muted></video>
          <div id="ar-overlay"></div>

          <!-- AR Controls overlay -->
          <div style="position:absolute; top:12px; left:12px; z-index:40;">
            <button id="btn-view-map" class="px-3 py-2 rounded bg-white">Peta</button>
          </div>

          <div style="position:absolute; top:12px; right:12px; z-index:40;" class="flex gap-2">
            <select id="vehicle-select" class="px-3 py-2 rounded">
              <option value="motor">Motor</option>
              <option value="mobil" selected>Mobil</option>
              <option value="truk">Truk</option>
            </select>
            <button id="btn-sampai" class="px-3 py-2 rounded bg-green-500 text-white">Sampai</button>
          </div>

          <!-- show emission result -->
          <div id="emission-result" style="position:absolute; bottom:14px; left:14px; z-index:40;" class="panel hidden"></div>
        </div>

        <!-- model viewer modal (for placing the .glb on ground) -->
        <div id="model-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
          <div class="bg-white rounded-lg w-[90%] max-w-2xl p-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-semibold">Lihat / Letakkan Objek (AR)</h3>
              <button id="close-model" class="px-2 py-1 rounded bg-gray-100">Tutup</button>
            </div>
            <model-viewer id="model-viewer" style="width:100%; height:70vh;" camera-controls ar ar-modes="webxr scene-viewer quick-look" interaction-prompt="auto"></model-viewer>
            <div class="mt-2 text-sm text-gray-600">Tekan tombol AR (jika tersedia) untuk menempatkan model di permukaan nyata.</div>
          </div>
        </div>
      </div>

      <!-- Right column: list + map -->
      <div class="">
        <div class="panel mb-4">
          <h4 class="font-semibold mb-2">Daftar Objek (CSV)</h4>
          <div id="object-list" class="space-y-2 max-h-[40vh] overflow-auto"></div>
        </div>

        <div class="panel">
          <h4 class="font-semibold mb-2">Peta (OpenStreetMap)</h4>
          <div id="student-map"></div>
          <div class="mt-2 text-xs text-gray-500">Titik start dicatat saat memilih objek; titik end dicatat saat tekan "Sampai".</div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  GeoEmisi AR - simplified flow:
  - CSV has only: name,url (glb)
  - When user clicks an object: capture current geolocation -> store as object's lat/lng and as startPoint
    and show option "Lihat Objek" which opens model-viewer (with ar)
  - When user taps "Sampai": capture geolocation -> store as endPoint, compute distance start->end, compute emissions
  - Vehicles: motor, mobil, truk with default emission factors (g CO2 per km)
  - Object in AR overlay is anchored by world coords (we simulate by Leaflet marker + overlay behavior)
*/

/* ========== CONFIG ========== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs7itzWflajvX9yJuHBaEOGwyRqUU2q7UXDJDbhaekQRxtAItAV-AH-BwaXzCTDLbCDbTVJRlFySt_/pub?gid=1923680956&single=true&output=csv';

// emission factors (g CO2 / km) — defaults, can be adjusted
const EMISSION_FACTORS = {
  motor: 120,   // motorcycle ~120 g/km (example)
  mobil: 200,   // car ~200 g/km (example)
  truk: 900     // truck ~900 g/km (example)
};

/* ========== STATE ========== */
let arContents = [];     // { id, title, url, lat?, lng?, startRecorded:bool }
let selected = null;     // currently selected object (reference)
let startPoint = null;   // {lat,lng}
let endPoint = null;
let currentPosition = null;

/* ========== UI refs ========== */
const statusEl = document.getElementById('status');
const objectListEl = document.getElementById('object-list');
const studentMapEl = document.getElementById('student-map');
const cameraVideo = document.getElementById('camera-feed');
const modelModal = document.getElementById('model-modal');
const modelViewer = document.getElementById('model-viewer');
const closeModelBtn = document.getElementById('close-model');
const btnSampai = document.getElementById('btn-sampai');
const vehicleSelect = document.getElementById('vehicle-select');
const emissionResult = document.getElementById('emission-result');
const arOverlay = document.getElementById('ar-overlay');
const btnViewMap = document.getElementById('btn-view-map');

let map = null;
let leafletMarkers = {}; // id -> marker

/* ========== UTILITIES ========== */
function parseCSV(text){
  const lines = text.trim().split('\n').map(l => l.trim()).filter(l=>l);
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
  const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('nama') || h.includes('title'));
  const urlIdx = headers.findIndex(h => h.includes('url') || h.includes('glb') || h.includes('model'));
  if(nameIdx === -1 || urlIdx === -1) throw new Error('CSV harus punya kolom name dan url');
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(',').map(c=>c.trim());
    if(cols[nameIdx] && cols[urlIdx]){
      rows.push({ title: cols[nameIdx], url: cols[urlIdx] });
    }
  }
  return rows;
}

// Haversine (meters)
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const toRad = v => v * Math.PI / 180;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2 - lat1), Δλ = toRad(lon2 - lon1);
  const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========== CSV LOADING ========== */
async function loadCSVAndPopulate(){
  statusEl.textContent = 'Memuat CSV...';
  try{
    const r = await fetch(CSV_URL);
    if(!r.ok) throw new Error('CSV fetch gagal');
    const txt = await r.text();
    const rows = parseCSV(txt);
    arContents = rows.map((r,i)=>({ id: 'obj_'+i, title: r.title, url: r.url, startRecorded:false }));
    statusEl.textContent = `Memuat ${arContents.length} objek. Pilih salah satu untuk mulai (lokasi akan dicatat saat pilih).`;
    renderObjectList();
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Gagal memuat CSV. Pastikan URL CSV bisa diakses publik.';
  }
}

/* ========== RENDER LIST ========== */

function renderObjectList(){
  objectListEl.innerHTML = '';
  arContents.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between p-2 border rounded';
    div.innerHTML = `
      <div>
        <div class="font-medium">${item.title}</div>
        <div class="text-xs text-gray-500">${item.url.split('/').pop()}</div>
      </div>
      <div class="flex flex-col gap-2 items-end">
        <div>
          <button data-id="${item.id}" class="btn-select px-3 py-1 rounded bg-blue-600 text-white text-sm">Pilih</button>
        </div>
        <div>
          <button data-id="${item.id}" class="btn-view px-3 py-1 rounded bg-gray-100 text-sm">Lihat Objek</button>
        </div>
      </div>
    `;
    objectListEl.appendChild(div);
  });

  // attach listeners
  document.querySelectorAll('.btn-select').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = e.currentTarget.dataset.id;
      await handleSelectObject(id);
    });
  });
  document.querySelectorAll('.btn-view').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id;
      handleViewObject(id);
    });
  });
}

/* ========== SELECT OBJECT => RECORD START LOCATION ========== */

async function handleSelectObject(id){
  const obj = arContents.find(o=>o.id===id);
  if(!obj) return;
  // Get current location
  statusEl.textContent = 'Mencatat lokasi start...';
  try{
    const pos = await getCurrentPositionPromise({ enableHighAccuracy:true, timeout:10000 });
    obj.lat = pos.coords.latitude;
    obj.lng = pos.coords.longitude;
    obj.startRecorded = true;
    startPoint = { lat: obj.lat, lng: obj.lng, time: Date.now(), objectId: obj.id };
    selected = obj;
    statusEl.textContent = `Dipilih: ${obj.title} — start dicatat (${obj.lat.toFixed(6)}, ${obj.lng.toFixed(6)})`;
    placeMarker(obj);
    // center map
    if(map) map.setView([obj.lat, obj.lng], 18);
  }catch(err){
    console.error(err);
    alert('Tidak dapat mengambil lokasi — pastikan izin lokasi diaktifkan.');
    statusEl.textContent = 'Gagal mencatat lokasi start.';
  }
}

/* ========== VIEW OBJECT (model-viewer) ========== */

function handleViewObject(id){
  const obj = arContents.find(o=>o.id===id);
  if(!obj) return;
  // set model-viewer src and open modal
  modelViewer.setAttribute('src', obj.url);
  modelModal.classList.remove('hidden');
  modelViewer.scrollIntoView({behavior:'smooth'});
}

closeModelBtn.addEventListener('click', ()=> modelModal.classList.add('hidden'));

/* ========== GEOLOCATION PROMISE ========== */

function getCurrentPositionPromise(options){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error('Geolocation not supported'));
    navigator.geolocation.getCurrentPosition(resolve, reject, options);
  });
}

/* ========== MAP / MARKERS ========== */

function initMap(){
  map = L.map('student-map', { zoomControl:false }).setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

function placeMarker(obj){
  // remove existing marker for id
  if(leafletMarkers[obj.id]){
    map.removeLayer(leafletMarkers[obj.id]);
  }
  const m = L.marker([obj.lat, obj.lng]).addTo(map).bindPopup(`<b>${obj.title}</b><br>Start`);
  leafletMarkers[obj.id] = m;
}

/* ========== CAMERA START ========== */
async function startCamera(){
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
      cameraVideo.srcObject = stream;
    }catch(err){
      console.warn('camera error', err);
      // fallthrough - camera optional
    }
  }
}

/* ========== Sampai (record end) & calculate emission ========== */

btnSampai.addEventListener('click', async ()=>{
  if(!selected || !selected.startRecorded){
    alert('Belum ada objek yang dipilih / start belum dicatat.');
    return;
  }
  statusEl.textContent = 'Mencatat lokasi sampai...';
  try{
    const pos = await getCurrentPositionPromise({ enableHighAccuracy:true, timeout:10000 });
    endPoint = { lat: pos.coords.latitude, lng: pos.coords.longitude, time: Date.now() };
    // place end marker
    if(leafletMarkers['end']) { map.removeLayer(leafletMarkers['end']); }
    leafletMarkers['end'] = L.marker([endPoint.lat, endPoint.lng], { icon: L.divIcon({ className:'', html:'<div class="p-1 bg-green-400 rounded-full"></div>', iconSize:[16,16] }) }).addTo(map).bindPopup('Sampai');
    // compute distance
    const meters = distanceMeters(selected.lat, selected.lng, endPoint.lat, endPoint.lng);
    const km = meters / 1000;
    const vehicle = vehicleSelect.value || 'mobil';
    const factor = EMISSION_FACTORS[vehicle] || EMISSION_FACTORS.mobil;
    const gramsCO2 = km * factor;
    // show result
    emissionResult.classList.remove('hidden');
    emissionResult.innerHTML = `
      <div><strong>Objek:</strong> ${selected.title}</div>
      <div><strong>Jarak:</strong> ${km.toFixed(3)} km (${Math.round(meters)} m)</div>
      <div><strong>Kendaraan:</strong> ${vehicle}</div>
      <div class="mt-2 text-lg font-semibold">Estimasi Emisi: ${ (gramsCO2/1000).toFixed(3) } kg CO₂</div>
    `;
    statusEl.textContent = 'Selesai: hasil emisi ditampilkan.';
    // draw line on map
    if(map){
      if(leafletMarkers['route']) map.removeLayer(leafletMarkers['route']);
      const poly = L.polyline([[selected.lat, selected.lng],[endPoint.lat,endPoint.lng]], { color:'#4f46e5' }).addTo(map);
      leafletMarkers['route'] = poly;
      map.fitBounds(poly.getBounds(), { padding:[40,40] });
    }
  }catch(err){
    console.error(err);
    alert('Gagal mencatat lokasi sampai. Pastikan izin lokasi diaktifkan.');
    statusEl.textContent = 'Gagal mencatat lokasi sampai.';
  }
});

/* ========== Keep AR object fixed relative to world coords ========== */
/* We'll simulate a simple world-anchor indicator in the camera overlay: show a small label
   at screen position mapped from bearing/distance. This remains fixed in world coords because
   we use the stored lat/lng of the object (not camera-relative). */

function updateAROverlay(){
  arOverlay.innerHTML = '';
  if(!currentPosition || !selected || !selected.startRecorded) return;
  const dist = distanceMeters(currentPosition.lat, currentPosition.lng, selected.lat, selected.lng);
  const bearing = calculateBearing(currentPosition.lat, currentPosition.lng, selected.lat, selected.lng);
  // compute relative bearing from device heading if available
  // Note: DeviceOrientationEvent alpha is not used here to keep implementation simple across browsers.
  // We'll place element at top-center and show distance & static direction arrow.
  const el = document.createElement('div');
  el.style.position = 'absolute';
  el.style.left = '50%';
  el.style.top = '10%';
  el.style.transform = 'translateX(-50%)';
  el.style.pointerEvents = 'auto';
  el.innerHTML = `
    <div style="background:rgba(255,255,255,0.85); padding:8px 12px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12);">
      <div style="font-weight:600">${selected.title}</div>
      <div style="font-size:13px;color:#374151">${Math.round(dist)} m • bearing ${Math.round(bearing)}°</div>
    </div>
  `;
  arOverlay.appendChild(el);
}

/* helper: bearing (deg) */
function calculateBearing(lat1, lon1, lat2, lon2){
  const toRad = v => v * Math.PI/180;
  const toDeg = v => v * 180/Math.PI;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  let θ = Math.atan2(y,x);
  θ = (toDeg(θ) + 360) % 360;
  return θ;
}

/* track current position for overlay & map updates */
function startTrackingPosition(){
  if(!navigator.geolocation) return;
  navigator.geolocation.watchPosition((p)=>{
    currentPosition = { lat:p.coords.latitude, lng:p.coords.longitude, accuracy:p.coords.accuracy };
    // update map center modestly
    if(map && (!selected || !selected.startRecorded)) {
      map.setView([currentPosition.lat, currentPosition.lng], 17);
    }
    // update overlay anchor
    updateAROverlay();
  }, (err)=>{
    console.warn('watchPosition err',err);
  }, { enableHighAccuracy:true, maximumAge:1000, timeout:5000 });
}

/* start everything */
(async function boot(){
  initMap();
  await loadCSVAndPopulate();
  await startCamera();
  startTrackingPosition();
  statusEl.textContent = 'Siap. Pilih objek dari daftar.';
  // open map toggle
  btnViewMap.addEventListener('click', ()=> {
    map.invalidateSize();
    // scroll to map area
    studentMapEl.scrollIntoView({behavior:'smooth'});
  });
})();

</script>
</body>
</html>
